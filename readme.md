# YurongOS 雨融

## 简介

YurongOS（雨融）是一个运行于 x86-64 平台的玩具级操作系统，使用 C++ 和汇编编写，纯 64 位模式，用很新的工具链构建。

系统的设计与实现参考以下项目：

* 同济大学计算机系《操作系统》课程教学实验系统 Unix V6++ OOS
* 踌躇月光操作系统课程实验系统 onix

主要在以下材料的帮助下推进：

* OSDev 网站
* 同济大学《操作系统原理》

特别感谢：

* 张H同学
* 方Y老师
* 邓R老师
* 沈J老师

实现计划（别骂了，确实还差很多没做呢）：

* [X] 启动引导（含基本分页）
* [X] 内存检测（获取基本信息）
* [X] 文本显示驱动
* [X] 通用开发库
* [X] 中断结构准备
* [ ] 内存检测（处理）
* [ ] 内核区分页
* [ ] 中断完善
* [ ] 用户区分页
* [ ] 文件系统（设计）
* [ ] 文件系统（外置编辑器）
* [ ] 高速缓存
* [ ] 文件系统（内核）
* [ ] ELF 解析
* [ ] 进程模型
* [ ] Shell

## 参考开发环境

这里列出一个参考环境。其他环境的开发体验不做保证。

> OS: Arch Linux
>
> Kernel: GNU/Linux 6.1.4
>
> Graphics: X11
>
> GCC: 12.2.0
>
> NASM: 2.15.05
>
> GNU Make: 4.3
>
> Qemu: 7.2.0

## 系统盘布局

|  盘块号  | 大小  |       用途       |
| :-------: | ----- | :---------------: |
|     0     | 512B  |     启动引导     |
|     1     | 512B  |        空        |
|  [2, 3]  | 1KB   | long mode 加载器 |
| [4, 1999] | 998KB | kernel 二进制文件 |
|          |       |       待定       |

## 物理内存布局

使用平铺模型（flat model），即描述符内注明的内存基地址就是 0，不做奇怪的变换。

地址使用16进制书写（带单位的除外）。

|     起始地址     |     终止地址（含）     |         大小         |           用途和备注           |
| :--------------: | :--------------------: | :-------------------: | :----------------------------: |
|       1000       |          1003          |          4B          |      内存检测 ards count      |
|       2000       |           ?           | ?<br />一般不超过400B |      内存检测 ards buffer      |
|        ?        |          6fff          |           ?           |     启动引导过程暂用运行栈     |
|       7000       |          73ff          |          1KB          |    启动引导程序：二级启动器    |
|       7c00       |          7dff          |         512B         |    启动引导程序：一级启动器    |
|       8000       |          bfff          |         16KB         | 临时四级页表（启动时内核暂用） |
| 10 0000<br />1MB | 3F FFFF<br />4MB - 1B |          3MB          |   核心栈<br />rsp = 40 FFFF   |
| 40 0000<br />4MB | 9F FFFF<br />10MB - 1B |          6MB          |        系统内核静态数据        |

## 内存映射

采用高位内核设计。

用户区：\[0x 0000 0000 0000 0000, 0x 0000 7FFF FFFF FFFF)

内核区：\[0x FFFF 8000 0000 0000, 0x FFFF FFFF FFFF FFFF\)

各 128TB。

|      起始地址      |   结束地址（含）   |        大小        | 物理起始地址 |  用途和备注  |
| :-----------------: | :-----------------: | :-----------------: | :----------: | :----------: |
| FFFF 8000 0000 0000 | FFFF 8000 005F FFFF | 6MB<br />1536 Pages |   40 0000   | 系统内核静态 |
| FFFF FFFF FFD0 0000 | FFFF FFFF FFFF FFFF | 3MB<br />768 Pages |   10 0000   |    核心栈    |

## 物理内存布局（x86 版本）

使用平铺模型（flat model），即描述符内注明的内存基地址就是 0，不做奇怪的变换。

地址使用16进制书写（带单位的除外）。

|           起始地址           | 终止地址（含） |         大小         |                                                                                                   用途和备注                                                                                                   |
| :--------------------------: | :------------: | :-------------------: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
|             1000             |      1003      |          4B          |                                                                                               内存检测 ards count                                                                                               |
|             2000             |       ?       | ?<br />一般不超过400B |                                                                                              内存检测 ards buffer                                                                                              |
|             7c00             |      7dff      |         512B         |                                                                                                  启动引导程序                                                                                                  |
| 7e00（理论界限）<br />31.5KB |     2f000     |        156.5KB        | 核心栈<br />从终止位置开始<br />向低位生长<br /><br />注意，生长时可能突破7e00，一直达到0位置<br />即：实际核心栈大小可以增长到 188KB<br />但是，低位内存保留有内存检测信息<br />核心栈突破限制可能带来安全隐患 |
|            30000            |     9fbff     |         447KB         |                                                        系统内核<br /><br />注意：修改内核加载地址时，需要同步<br />在链接脚本和启动引导相关位置做修改。                                                        |
|             1MB             |   不超过 3GB   |     最好大于 32MB     |                                                                                                      待定                                                                                                      |
